# Additional Card Elements - Board Settings

## Автосинхронизация с Board Property

**Поведение**: При изменении настроек в сторе автоматически сохраняются в Board Property с throttling (5 секунд). При загрузке страницы настройки автоматически загружаются из Board Property.

**Реализация**:
- `loadAdditionalCardElementsBoardProperty` - загружает настройки при инициализации
- `autosyncStoreWithBoardProperty` - автоматически сохраняет изменения в Board Property
- Используется throttling для предотвращения частых запросов к API

## Общие блоки

### Включение показа доп элементов

**Компонент**: Checkbox
**Поведение** Состояние чекбокса (включен выключен) связано с `boardProperty.enabled`. Если чекбокс выключен - другие элементы не отображаются


### Сброс настроек

**Компонент**: Кнопка
**Поведение**: При нажатии состояние `boardProperty` сбрасывается на изначальное

### Выбор колонок

**Компонент**: Shared/ColumnsSelector
**Поведение** Включенные колонки хранятся в `boardProperty.columnsToTrack`

### Показ IssueLinks

**User Story**:
- Я хочу видеть на доске, с какой задачей связана каждая карточка. Как правило, это связь с задачей, которая представляет собой "Проект" в jira, которая заведен отдельной задачей и привязан через какой-то линк

Кейсы:
- Я хочу видеть все задачи, которые привязаны к текущей задаче по связи `is Parent of`
- Я хочу видеть все задачи с типом Project, которые привязаны к текущей задаче по связи `is Parent of`
- Я хочу видеть все задачи с типом Project в незавершенных статусах, которые привязаны к текущей задаче по связи `is Parent of`
- Я хочу видеть все незавершенные задачи с типом Project и все задачи с типом Objective и лейблом "Бизнес", которые привязаны к текущей задаче по связи `is Parent of`

**Компонент**: Кастомный
**Поведение**: При маунте инициализируется загрузка доступных связей проекта через хук `useGetIssueLinkTypes`. Пока грузится - показываем скелетон. Если связи загрузились и они не пустые - показываем компонент. Если пустые - показываем что не удалось загрузить связи проекта или их нет, поэтому невозможно настроить показ связей.
**Структура**:
- Список настроек показываемых IssueLinks. Данные связаны с `boardProperty.issueLinks`
  - Один IssueLink
    - **Компонент**: карточка
      - Название IssueLinks. 
        - **Компонент**: Input. Расположен в заголовке карточки
        - **Поведение**: Берется из `boardProperty.issueLinks[i].name`. Ограничено 20 символами.
      - **Строка 1**: Выбор типа связи и цвета
        - Выбор типа связи
          - **Компонент**: Dropdown. Расположен в карточке
          - **Поведение**: берутся все доступные связи из `useGetIssueLinkTypes` и формируется список значений для дропдауна из name.  Т.к. name - не уникальны, как ключ объекта следует использовать id линка + direction линка. Выбранное значение сохраняется в `boardProperty.issueLinks[i].linkType` - сохраняется id и direction.
        - Выбор цвета:
          - **Компонент**: Checkbox + ColorPicker
          - **Поведение**: значение связано с `boardProperty.issueLinks[i].color`. Если чекбокс выключен - colorPicker не показывается, значение поля в boardProperty прописывается как undefined. Если чекбокс включен - показан ColorPicker, его значение записывается в boardProperty.
      - **Строка 2**: Выбор сущностей, связи которых следует учитывать
        - **Компонент**: `shared/components/issueSelectorByAttributes`. Расположен в карточке на отдельной строке.
        - **Поведение**: значение связано с `boardProperty.issueLinks[i].issueSelector`, сохраняется as is. По умолчанию - пустое значение.
- Кнопка добавления нового IssueLink
  - **Компонент**: Кнопка с иконкой
  - **Поведение**: При клике добавляется новый IssueLink с базовыми параметрами: название Link + порядковый номер связи, тип связи = первый id, inward

# Отображение связей на карточках

## Общие принципы

**Поведение**: На каждой карточке задачи отображаются связи согласно настроенным IssueLinks. Связи показываются только в колонках, указанных в `boardProperty.columnsToTrack`.

**Условия отображения**:
- Функция должна быть включена (`boardProperty.enabled = true`)
- Карточка должна находиться в отслеживаемой колонке
- Должны быть настроены IssueLinks

## Структура отображения

**Компонент**: `AdditionalCardElementsContainer`
**Расположение**: Внизу карточки задачи, под основной информацией
**Стиль**: Вертикальный список бейджей с цветовой индикацией

### Логика получения связей

**Для каждого настроенного IssueLink**:
1. **Получение связанных задач**: Используется Jira API для получения задач по связи
   - Тип связи: `linkType.id` + `linkType.direction`
   - Фильтр задач: `issueSelector` (JQL или поле)
   
2. **Фильтрация результатов**: Применяется `issueSelector` для отбора нужных задач
   - Если `issueSelector.mode = 'jql'` - применяется JQL фильтр
   - Если `issueSelector.mode = 'field'` - фильтр по полю и значению

3. **Группировка и отображение**: Связанные задачи группируются по типу связи

### Цветовая схема

**Приоритет цветов**:
1. **Кастомный цвет**: Если в настройках IssueLink указан `color` - используется он
2. **Автоматический цвет**: Если цвет не указан, вычисляется на основе хеш-функции

**Алгоритм автоматического цвета**:
```typescript
function getAutoColor(issueKey: string, issueSummary: string): string {
  const hashInput = issueKey + issueSummary;
  const hash = simpleHash(hashInput);
  const colorIndex = hash % PASTEL_COLORS.length;
  return PASTEL_COLORS[colorIndex];
}
```

**Массив пастельных цветов**: 50 предопределенных пастельных цветов для консистентного отображения

### Компоненты отображения

#### IssueLinkBadges
**Назначение**: Отображение связей
**Props**:
- `key`: issue-key

**Поведение**:
- Отображает `IssueLinkBadge` для каждой связи
- **onMount** если фича включена, то получает issue links из `issue.data.fields.issuelinks` (данные уже загружены через `fetchJiraIssue`)
- Получает список отслеживаемых связей из `useGetSettings().settings.issueLinks` (настройки из `useAdditionalCardElementsBoardPropertyStore`)
- Для каждой связанной задачи проверяет, подходит ли она под условия отслеживания через `issueSelector` (JQL парсер или фильтр по полю). Для тех, что подходят высчитывает цвет через `getLinkColor()` из `colorUtils.ts`, если он не определен в настройках. Формирует массив links: `{color: string, link: string, summary: string}[]`. Массив рендерится как `IssueLinkBadge`
- Пока идет загрузка данных - ничего не отображается. Отображение есть только если есть настройки отслеживаемых связей и подходящие под эти связи задачи

#### IssueLinkBadge
**Назначение**: Отображение одной связи
**Props**:
- `color`: Цвет для отображения
- `link`: Ссылка на задачу
- `summary`: Название задачи. Должно скрываться за троеточием, если элемент не влезает в родительский контейнер. При наведении мышки можно полное название

**Поведение**:
- При клике открывает связанную задачу в новой вкладке
- Текст бейджа содержит только summary

### Тестирование

**Unit тесты**:
- Логика вычисления цветов
- Фильтрация связанных задач
- Формирование ссылок
- Пустое отображение если нет задач, нет конфига или нет задач под конфиг

**Storybook**:
- Отображение нескольких бейджей. Комбинируем проверки
  - Цвет из конфига
  - Высчитанный цвет
  - Короткий Summary
  - Длинный Summary