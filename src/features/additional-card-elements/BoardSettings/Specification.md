# Additional Card Elements - Board Settings

## Автосинхронизация с Board Property

**Поведение**: При изменении настроек в сторе автоматически сохраняются в Board Property с throttling (5 секунд). При загрузке страницы настройки автоматически загружаются из Board Property.

**Реализация**:
- `loadAdditionalCardElementsBoardProperty` - загружает настройки при инициализации
- `autosyncStoreWithBoardProperty` - автоматически сохраняет изменения в Board Property
- Используется throttling для предотвращения частых запросов к API

## Общие блоки

### Включение показа доп элементов

**Компонент**: Checkbox
**Поведение** Состояние чекбокса (включен выключен) связано с `boardProperty.enabled`. Если чекбокс выключен - другие элементы не отображаются


### Сброс настроек

**Компонент**: Кнопка
**Поведение**: При нажатии состояние `boardProperty` сбрасывается на изначальное

### Выбор колонок

**Компонент**: Shared/ColumnsSelector
**Поведение** Включенные колонки хранятся в `boardProperty.columnsToTrack`

### Показ IssueLinks

**User Story**:
- Я хочу видеть на доске, с какой задачей связана каждая карточка. Как правило, это связь с задачей, которая представляет собой "Проект" в jira, которая заведен отдельной задачей и привязан через какой-то линк

Кейсы:
- Я хочу видеть все задачи, которые привязаны к текущей задаче по связи `is Parent of`
- Я хочу видеть все задачи с типом Project, которые привязаны к текущей задаче по связи `is Parent of`
- Я хочу видеть все задачи с типом Project в незавершенных статусах, которые привязаны к текущей задаче по связи `is Parent of`
- Я хочу видеть все незавершенные задачи с типом Project и все задачи с типом Objective и лейблом "Бизнес", которые привязаны к текущей задаче по связи `is Parent of`

**Компонент**: Кастомный
**Поведение**: При маунте инициализируется загрузка доступных связей проекта через хук `useGetIssueLinkTypes`. Пока грузится - показываем скелетон. Если связи загрузились и они не пустые - показываем компонент. Если пустые - показываем что не удалось загрузить связи проекта или их нет, поэтому невозможно настроить показ связей.
**Структура**:
- Список настроек показываемых IssueLinks. Данные связаны с `boardProperty.issueLinks`
  - Один IssueLink
    - **Компонент**: карточка
      - Название IssueLinks. 
        - **Компонент**: Input. Расположен в заголовке карточки
        - **Поведение**: Берется из `boardProperty.issueLinks[i].name`. Ограничено 20 символами.
      - **Строка 1**: Выбор типа связи и отображения
        - Выбор типа связи
          - **Компонент**: Dropdown. Расположен в карточке. Ширина дропдауна равна ширине самого длинного элемента.
          - **Поведение**: берутся все доступные связи из `useGetIssueLinkTypes` и формируется список значений для дропдауна из name.  Т.к. name - не уникальны, как ключ объекта следует использовать id линка + direction линка. Выбранное значение сохраняется в `boardProperty.issueLinks[i].linkType` - сохраняется id и direction.
        - Использование уникальных цветов для каждой задачи:
          - **Компонент**: Checkbox + ColorPicker
          - **Поведение**: значение связано с `boardProperty.issueLinks[i].color`. Если `boardProperty.issueLinks[i].color` не undefined - чекбокс включен, название чекбокса "Уникальные цвета для задач", colorPicker не показывается. Если значение поля установлено, то чекбокс выключен, показывается ColorPicker, его значение записывается в boardProperty.
        - Многострочность:
         - **Компонент**: Checkbox
         - **Поведение**: Значение связано с `boardProperty.issueLinks[i].multilineSummary`
      - **Строка 2**: Выбор задач, для которых анализируем связи
        - **Компонент**: div + display: flex-row
        - Выбор опции "Учитывать все задачи"
          - **Компонент**: Checkbox + tooltip
          - **Поведение**: Checkbox связан с `boardProperty.issueLinks[i].trackAllTasks`. В tooltip описано, что можно либо учитывать связи всех задач, либо настроить более гранулярно.
        - Указание задач, для которых анализируем связи
          - **Компонент**: `shared/components/issueSelectorByAttributes`.
          - **Поведение**:
            - Не отображается если `boardProperty.issueLinks[i].trackAllTasks` === true
            - Значение связано с `boardProperty.issueLinks[i].issueSelector`, сохраняется as is. По умолчанию - пустое значение
      - **Строка 3**: Выбор задач, связи с которыми анализируем
        - **Компонент**: div + display: flex-row
        - Выбор опции "Учитывать все задачи"
          - **Компонент**: Checkbox + tooltip
          - **Поведение**: Checkbox связан с `boardProperty.issueLinks[i].trackAllLinkedTasks`. В tooltip описано, что можно либо связи с любыми задачами, либо настроить более гранулярно и учитывать связи с определенными задачами.
        - **Компонент**: `shared/components/issueSelectorByAttributes`
        - **Поведение**: значение связано с `boardProperty.issueLinks[i].linkedIssueSelector`, сохраняется as is. По умолчанию - пустое значение.
- Кнопка добавления нового IssueLink
  - **Компонент**: Кнопка с иконкой
  - **Поведение**: При клике добавляется новый IssueLink с базовыми параметрами: название Link + порядковый номер связи, тип связи = первый id, inward

# Отображение связей на карточках

## Общие принципы

**Поведение**: На каждой карточке задачи отображаются связи согласно настроенным IssueLinks. Связи показываются только в колонках, указанных в `boardProperty.columnsToTrack`.

**Условия отображения**:
- Функция должна быть включена (`boardProperty.enabled = true`)
- Карточка должна находиться в отслеживаемой колонке
- Должны быть настроены IssueLinks

## Структура отображения

**Компонент**: `AdditionalCardElementsContainer`
**Расположение**: Внизу карточки задачи, под основной информацией
**Стиль**: Вертикальный список бейджей с цветовой индикацией

### Логика получения связей

**Для каждой карточки задачи и каждого настроенного IssueLink**:

1. **Проверка, нужно ли анализировать связи для текущей задачи**:
   - Если `trackAllTasks === true` - анализируем связи для всех задач
   - Если `trackAllTasks === false` - проверяем, подходит ли текущая задача под условия `issueSelector`:
     - Если `issueSelector.mode = 'jql'` - применяется JQL фильтр к данным текущей задачи
     - Если `issueSelector.mode = 'field'` - фильтр по полю и значению текущей задачи
   - Если текущая задача не подходит под условия - пропускаем этот IssueLink для данной карточки

2. **Получение связанных задач**: Используется Jira API для получения задач по связи
   - Тип связи: `linkType.id` + `linkType.direction`
   - Получаются все связанные задачи для текущей карточки
   
3. **Фильтрация связанных задач**: Применяется фильтр для отбора нужных связанных задач
   - Если `trackAllLinkedTasks === true` - учитываются все связанные задачи
   - Если `trackAllLinkedTasks === false` - применяется `linkedIssueSelector`:
     - Если `linkedIssueSelector.mode = 'jql'` - применяется JQL фильтр к данным связанной задачи
     - Если `linkedIssueSelector.mode = 'field'` - фильтр по полю и значению связанной задачи
   - Если связанная задача не подходит под условия - она не отображается

4. **Группировка и отображение**: Отфильтрованные связанные задачи группируются по типу связи и отображаются как бейджи

### Цветовая схема

**Приоритет цветов**:
1. **Кастомный цвет**: Если в настройках IssueLink указан `color` - используется он
2. **Автоматический цвет**: Если цвет не указан, вычисляется на основе хеш-функции

**Алгоритм автоматического цвета**:
```typescript
function getAutoColor(issueKey: string, issueSummary: string): string {
  const hashInput = issueKey + issueSummary;
  const hash = simpleHash(hashInput);
  const colorIndex = hash % PASTEL_COLORS.length;
  return PASTEL_COLORS[colorIndex];
}
```

**Массив пастельных цветов**: 20 предопределенных легко различимых цветов (пастельных и более насыщенных) для консистентного отображения

### Компоненты отображения

#### IssueLinkBadges
**Назначение**: Отображение связей
**Props**:
- `key`: issue-key

**Поведение**:
- Отображает `IssueLinkBadge` для каждой связи
- **onMount** если фича включена, то получает issue links из `issue.data.fields.issuelinks` (данные уже загружены через `fetchJiraIssue`)
- Получает список отслеживаемых связей из `useGetSettings().settings.issueLinks` (настройки из `useAdditionalCardElementsBoardPropertyStore`)
- Для каждого настроенного IssueLink:
  1. Проверяет, нужно ли анализировать связи для текущей карточки:
     - Если `trackAllTasks === true` - анализируем связи
     - Если `trackAllTasks === false` - проверяет, подходит ли текущая задача под условия `issueSelector` (JQL парсер или фильтр по полю). Если не подходит - пропускает этот IssueLink
  2. Получает все связанные задачи для текущей карточки по типу связи (`linkType.id` + `linkType.direction`)
  3. Фильтрует связанные задачи:
     - Если `trackAllLinkedTasks === true` - учитываются все связанные задачи
     - Если `trackAllLinkedTasks === false` - проверяет, подходит ли связанная задача под условия `linkedIssueSelector` (JQL парсер или фильтр по полю). Если не подходит - пропускает эту связанную задачу
  4. Для каждой подходящей связанной задачи высчитывает цвет через `getLinkColor()` из `colorUtils.ts` (используется `color` из настроек IssueLink, если он определен, иначе автоматический цвет)
  5. Формирует массив links: `{color: string, link: string, summary: string, multilineSummary: boolean}[]`
- Массив links рендерится как `IssueLinkBadge` для каждого IssueLink
- Пока идет загрузка данных - ничего не отображается. Отображение есть только если есть настройки отслеживаемых связей и подходящие под эти связи задачи

#### IssueLinkBadge
**Назначение**: Отображение одной связи
**Props**:
- `color`: Цвет для отображения
- `link`: Ссылка на задачу
- `summary`: Название задачи
- `multilineSummary`: если true, то в случае если summary не влазиет в 1 строку, слова переносятся на следующую. Иначе часть summary, которая не помещается, должна скрываться за троеточием, а при наведении мышки можно увидеть полное название в тултипе 

**Поведение**:
- При клике открывает связанную задачу в новой вкладке
- Текст бейджа содержит только summary

### Тестирование

**Unit тесты**:
- Логика вычисления цветов
- Фильтрация связанных задач
- Формирование ссылок
- Пустое отображение если нет задач, нет конфига или нет задач под конфиг

**Storybook**:
- Отображение нескольких бейджей. Комбинируем проверки
  - Цвет из конфига
  - Высчитанный цвет
  - Короткий Summary
  - Длинный Summary