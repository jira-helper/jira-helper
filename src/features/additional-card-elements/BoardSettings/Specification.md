# Additional Card Elements - Board Settings

## Автосинхронизация с Board Property

**Поведение**: При изменении настроек в сторе автоматически сохраняются в Board Property с throttling (5 секунд). При загрузке страницы настройки автоматически загружаются из Board Property.

**Реализация**:
- `loadAdditionalCardElementsBoardProperty` - загружает настройки при инициализации
- `autosyncStoreWithBoardProperty` - автоматически сохраняет изменения в Board Property
- Используется throttling для предотвращения частых запросов к API

## Общие блоки

### Включение показа доп элементов

**Компонент**: Checkbox
**Поведение** Состояние чекбокса (включен выключен) связано с `boardProperty.enabled`. Если чекбокс выключен - другие элементы не отображаются


### Сброс настроек

**Компонент**: Кнопка
**Поведение**: При нажатии состояние `boardProperty` сбрасывается на изначальное

### Выбор колонок

**Компонент**: Shared/ColumnsSelector
**Поведение** Включенные колонки хранятся в `boardProperty.columnsToTrack`


### Показывать ли в беклоге

**Компонент**: Checkbox
**Поведение**: связан с `boardProperty.showInBacklog`. Отображается рядом с колонками

### Показ IssueLinks

**User Story**:
- Я хочу видеть на доске, с какой задачей связана каждая карточка. Как правило, это связь с задачей, которая представляет собой "Проект" в jira, которая заведен отдельной задачей и привязан через какой-то линк

Кейсы:
- Я хочу видеть все задачи, которые привязаны к текущей задаче по связи `is Parent of`
- Я хочу видеть все задачи с типом Project, которые привязаны к текущей задаче по связи `is Parent of`
- Я хочу видеть все задачи с типом Project в незавершенных статусах, которые привязаны к текущей задаче по связи `is Parent of`
- Я хочу видеть все незавершенные задачи с типом Project и все задачи с типом Objective и лейблом "Бизнес", которые привязаны к текущей задаче по связи `is Parent of`
- Я хочу видеть связанные задач не только на доске с задачами, но и в беклоге

**Компонент**: Кастомный
**Поведение**: При маунте инициализируется загрузка доступных связей проекта через хук `useGetIssueLinkTypes`. Пока грузится - показываем скелетон. Если связи загрузились и они не пустые - показываем компонент. Если пустые - показываем что не удалось загрузить связи проекта или их нет, поэтому невозможно настроить показ связей.
**Структура**:
- Список настроек показываемых IssueLinks. Данные связаны с `boardProperty.issueLinks`
  - Один IssueLink
    - **Компонент**: карточка
      - Название IssueLinks. 
        - **Компонент**: Input. Расположен в заголовке карточки
        - **Поведение**: Берется из `boardProperty.issueLinks[i].name`. Ограничено 20 символами.
      - **Строка 1**: Выбор типа связи и отображения
        - Выбор типа связи
          - **Компонент**: Dropdown. Расположен в карточке. Ширина дропдауна равна ширине самого длинного элемента.
          - **Поведение**: берутся все доступные связи из `useGetIssueLinkTypes` и формируется список значений для дропдауна из name.  Т.к. name - не уникальны, как ключ объекта следует использовать id линка + direction линка. Выбранное значение сохраняется в `boardProperty.issueLinks[i].linkType` - сохраняется id и direction.
        - Использование уникальных цветов для каждой задачи:
          - **Компонент**: Checkbox + ColorPicker
          - **Поведение**: значение связано с `boardProperty.issueLinks[i].color`. Если `boardProperty.issueLinks[i].color` не undefined - чекбокс включен, название чекбокса "Уникальные цвета для задач", colorPicker не показывается. Если значение поля установлено, то чекбокс выключен, показывается ColorPicker, его значение записывается в boardProperty.
        - Многострочность:
         - **Компонент**: Checkbox
         - **Поведение**: Значение связано с `boardProperty.issueLinks[i].multilineSummary`
      - **Строка 2**: Выбор задач, для которых анализируем связи
        - **Компонент**: div + display: flex-row
        - Выбор опции "Учитывать все задачи"
          - **Компонент**: Checkbox + tooltip
          - **Поведение**: Checkbox связан с `boardProperty.issueLinks[i].trackAllTasks`. В tooltip описано, что можно либо учитывать связи всех задач, либо настроить более гранулярно.
        - Указание задач, для которых анализируем связи
          - **Компонент**: `shared/components/issueSelectorByAttributes`.
          - **Поведение**:
            - Не отображается если `boardProperty.issueLinks[i].trackAllTasks` === true
            - Значение связано с `boardProperty.issueLinks[i].issueSelector`, сохраняется as is. По умолчанию - пустое значение
      - **Строка 3**: Выбор задач, связи с которыми анализируем
        - **Компонент**: div + display: flex-row
        - Выбор опции "Учитывать все задачи"
          - **Компонент**: Checkbox + tooltip
          - **Поведение**: Checkbox связан с `boardProperty.issueLinks[i].trackAllLinkedTasks`. В tooltip описано, что можно либо связи с любыми задачами, либо настроить более гранулярно и учитывать связи с определенными задачами.
        - **Компонент**: `shared/components/issueSelectorByAttributes`
        - **Поведение**: значение связано с `boardProperty.issueLinks[i].linkedIssueSelector`, сохраняется as is. По умолчанию - пустое значение.
- Кнопка добавления нового IssueLink
  - **Компонент**: Кнопка с иконкой
  - **Поведение**: При клике добавляется новый IssueLink с базовыми параметрами: название Link + порядковый номер связи, тип связи = первый id, inward

# Виджет отображения связей (IssueLinkBadges)

## Общие принципы

**Компонент**: `IssueLinkBadges`
**Назначение**: Универсальный виджет для отображения связей между задачами. Используется как на доске, так и в беклоге.

**Props**:
- `issueKey: string` - ключ задачи, для которой отображаются связи
- `horizontal?: boolean` - режим отображения (горизонтальный или вертикальный), по умолчанию `false` (вертикальный)

## Логика получения связей

**Для каждой карточки задачи и каждого настроенного IssueLink**:

1. **Проверка, нужно ли анализировать связи для текущей задачи**:
   - Если `trackAllTasks === true` - анализируем связи для всех задач
   - Если `trackAllTasks === false` - проверяем, подходит ли текущая задача под условия `issueSelector`:
     - Если `issueSelector.mode = 'jql'` - применяется JQL фильтр к данным текущей задачи
     - Если `issueSelector.mode = 'field'` - фильтр по полю и значению текущей задачи
   - Если текущая задача не подходит под условия - пропускаем этот IssueLink для данной карточки

2. **Получение связанных задач**: Используется Jira API для получения задач по связи
   - Тип связи: `linkType.id` + `linkType.direction`
   - Получаются все связанные задачи для текущей карточки
   - Данные берутся из `issue.data.fields.issuelinks` (уже загружены через `fetchJiraIssue`)
   
3. **Фильтрация связанных задач**: Применяется фильтр для отбора нужных связанных задач
   - Если `trackAllLinkedTasks === true` - учитываются все связанные задачи
   - Если `trackAllLinkedTasks === false` - применяется `linkedIssueSelector`:
     - Если `linkedIssueSelector.mode = 'jql'` - применяется JQL фильтр к данным связанной задачи
     - Если `linkedIssueSelector.mode = 'field'` - фильтр по полю и значению связанной задачи
   - Если связанная задача не подходит под условия - она не отображается

4. **Группировка и отображение**: Отфильтрованные связанные задачи группируются по типу связи и отображаются как бейджи

## Режимы отображения

### Вертикальный режим (по умолчанию)
- Используется на доске
- `flexDirection: 'column'`
- `flexWrap: 'nowrap'`
- Бейджи располагаются друг под другом

### Горизонтальный режим
- Используется в беклоге
- `flexDirection: 'row'`
- `flexWrap: 'wrap'`
- Бейджи располагаются в ряд, с переносом на новую строку при необходимости

### Цветовая схема

**Приоритет цветов**:
1. **Кастомный цвет**: Если в настройках IssueLink указан `color` - используется он
2. **Автоматический цвет**: Если цвет не указан, вычисляется на основе хеш-функции

**Алгоритм автоматического цвета**:
```typescript
function getAutoColor(issueKey: string, issueSummary: string): string {
  const hashInput = issueKey + issueSummary;
  const hash = simpleHash(hashInput);
  const colorIndex = hash % PASTEL_COLORS.length;
  return PASTEL_COLORS[colorIndex];
}
```

**Массив пастельных цветов**: 20 предопределенных легко различимых цветов (пастельных и более насыщенных) для консистентного отображения

### Компоненты виджета

#### IssueLinkBadge
**Назначение**: Отображение одной связи
**Props**:
- `color`: Цвет для отображения
- `link`: Ссылка на задачу
- `summary`: Название задачи
- `multilineSummary`: если true, то в случае если summary не влазиет в 1 строку, слова переносятся на следующую. Иначе часть summary, которая не помещается, должна скрываться за троеточием, а при наведении мышки можно увидеть полное название в тултипе 

**Поведение**:
- При клике открывает связанную задачу в новой вкладке
- Текст бейджа содержит только summary

---

# Интеграция на доску (Board Page)

## Общие принципы

**Поведение**: На каждой карточке задачи отображаются связи согласно настроенным IssueLinks. Связи показываются только в колонках, указанных в `boardProperty.columnsToTrack`.

**Условия отображения**:
- Функция должна быть включена (`boardProperty.enabled = true`)
- Карточка должна находиться в отслеживаемой колонке (`boardProperty.columnsToTrack` содержит колонку карточки)
- Должны быть настроены IssueLinks

## Структура отображения

**Компонент**: `AdditionalCardElementsContainer`
**Расположение**: На карточке под заголовком (position: 'aftersummary')
**Стиль**: Вертикальный список бейджей с цветовой индикацией

### Логика работы контейнера

1. **Проверка условий отображения**:
   - Проверяет `settings.enabled`
   - Получает колонку карточки через `boardPage.getColumnOfIssue(issueId)`
   - Проверяет, что колонка входит в `settings.columnsToTrack`

2. **Загрузка данных**:
   - При монтировании, если условия выполнены, загружает подзадачи через `loadSubtasksForIssue(issueId)`
   - Используется `AbortController` для отмены загрузки при размонтировании

3. **Рендеринг виджета**:
   - Если условия выполнены, рендерит `IssueLinkBadges` с `issueKey={issueId}` (без пропа `horizontal`, используется вертикальный режим по умолчанию)
   - Если условия не выполнены, возвращает `null`

### Интеграция в страницу

**Класс**: `AdditionalCardElementsBoardPage`
**Метод**: `apply()`

1. Загружает настройки через `loadAdditionalCardElementsBoardProperty()`
2. Настраивает автосинхронизацию через `autosyncStoreWithBoardProperty()`
3. Подписывается на события карточек через `BoardPagePageObject.listenCards()`
4. Для каждой карточки прикрепляет `AdditionalCardElementsContainer` с позицией `'aftersummary'`

### Тестирование

**Unit тесты**:
- Логика вычисления цветов
- Фильтрация связанных задач
- Формирование ссылок
- Пустое отображение если нет задач, нет конфига или нет задач под конфиг

**Storybook**:
- Отображение нескольких бейджей. Комбинируем проверки
  - Цвет из конфига
  - Высчитанный цвет
  - Короткий Summary
  - Длинный Summary


# Интеграция в беклог (Backlog Page)

## Общие принципы

**Поведение**: На каждой карточке задачи в беклоге отображаются связи согласно настроенным IssueLinks.

**Условия отображения**:
- Функция должна быть включена (`boardProperty.enabled = true`)
- Отображение в беклоге должно быть включено (`boardProperty.showInBacklog = true`)
- Должны быть настроены IssueLinks
- **Важно**: В беклоге не проверяются колонки (в беклоге нет колонок)

## Структура отображения

**Компонент**: `AdditionalCardElementsBacklogContainer`
**Расположение**: В конце карточки (`.ghx-end`)
**Стиль**: Горизонтальный список бейджей с цветовой индикацией

### Логика работы контейнера

1. **Проверка условий отображения**:
   - Проверяет `settings.enabled`
   - Проверяет `settings.showInBacklog`
   - **Не проверяет колонки** (в беклоге нет колонок)

2. **Загрузка данных**:
   - При монтировании, если условия выполнены, загружает подзадачи через `loadSubtasksForIssue(issueId)`
   - Используется `AbortController` для отмены загрузки при размонтировании

3. **Рендеринг виджета**:
   - Если условия выполнены, рендерит `IssueLinkBadges` с `issueKey={issueId}` и `horizontal={true}` (горизонтальный режим)
   - Если условия не выполнены, возвращает `null`

### Интеграция в страницу

**Класс**: `AdditionalCardElementsBoardBacklogPage`
**Метод**: `apply()`

1. Загружает настройки через `loadAdditionalCardElementsBoardProperty()`
2. Подписывается на события карточек через `BoardBacklogPagePageObject.listenCards()`
3. Для каждой карточки прикрепляет `AdditionalCardElementsBacklogContainer` в конец карточки (`.ghx-end`)

### Отличия от доски

- **Не проверяются колонки**: В беклоге нет колонок, поэтому проверка `columnsToTrack` не выполняется
- **Горизонтальное отображение**: Бейджи располагаются в ряд, а не друг под другом
- **Отдельная настройка**: Включение отображения в беклоге контролируется отдельной настройкой `showInBacklog`